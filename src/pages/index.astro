---
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
import CommandBox from "../components/CommandBox.astro";
import InputBox from "../components/InputBox.astro";

import commandsData from "../data/commands.json";
import type { CommandData } from "../types/commands";

const commands: CommandData = commandsData;
const tabs = Object.keys(commands);
const categories = Array.from(
	new Set(Object.values(commands).flatMap((section) => Object.keys(section))),
);
---

<Layout>
	<main class="h-screen bg-gray-950 text-white font-mono p-4 overflow-hidden">
		<div
			class="h-full max-w-screen-lg mx-auto border-2 border-white p-4 rounded-xl flex flex-col"
		>
			<!-- Header -->
			<div
				class="flex justify-between items-center mb-4 border-b border-white pb-2"
			>
				<div class="text-xl font-bold tracking-wider">NetRunners</div>
				<nav class="space-x-4">
					<button class="text-white hover:underline">COMMANDS</button>
					<button class="text-white hover:underline">WRITEUPS</button>
					<button class="text-white hover:underline">SUPPORT</button>
					<button class="text-white hover:underline">About</button>
				</nav>
			</div>

			<div class="grid grid-cols-3 gap-4 flex-grow overflow-hidden">
				<!-- Left Form Inputs -->
				<div class="space-y-4" id="input-form">
					<InputBox label="IP" />
					<InputBox label="PUERTO" />
					<InputBox label="USUARIO" />
					<InputBox label="CONTRASEÑA" />
					<InputBox label="DOMINIO" />
				</div>

				<!-- Command Section -->
				<div class="col-span-2 flex flex-col overflow-hidden">
					<div class="flex space-x-2 border-b border-white pb-2 mb-2">
						{
							tabs.map((tab, index) => (
								<button
									class={`tab-btn px-4 py-1 border border-white rounded-md ${index === 0 ? "bg-white text-black" : "text-white"}`}
									data-tab={tab}
								>
									{tab.toUpperCase()}
								</button>
							))
						}
					</div>

					<!-- Category Filter Checkboxes -->
					<div class="mb-4">
						<p class="text-sm text-gray-400 mb-2">
							Filtrar Categorías:
						</p>
						<div class="flex flex-wrap gap-2">
							{
								categories.map((cat) => (
									<label class="flex items-center space-x-1">
										<input
											type="checkbox"
											value={cat}
											class="category-filter"
											checked
										/>
										<span class="capitalize text-sm">
											{cat}
										</span>
									</label>
								))
							}
						</div>
					</div>

					<div
						id="tab-content"
						class="space-y-2 flex-grow overflow-y-auto pr-2"
					>
						{
							tabs.map((tab, index) => (
								<div
									data-tab-content={tab}
									class={`${index !== 0 ? "hidden" : ""} space-y-2`}
								>
									{Object.entries(commands[tab]).flatMap(
										([category, cmds]) =>
											cmds.map((cmd) => (
												<div data-category={category}>
													<CommandBox command={cmd} />
												</div>
											)),
									)}
								</div>
							))
						}
					</div>
				</div>
			</div>
		</div>

		<!-- Script para tabs, inputs y filtros -->
		<script>
			const tabButtons = document.querySelectorAll(".tab-btn");
			const tabContents = document.querySelectorAll("[data-tab-content]");

			tabButtons.forEach((btn) => {
				btn.addEventListener("click", () => {
					tabButtons.forEach((b) => {
						b.classList.remove("bg-white", "text-black");
						b.classList.add("text-white");
					});
					btn.classList.add("bg-white", "text-black");
					btn.classList.remove("text-white");

					const target = (btn as HTMLElement).dataset.tab;
					tabContents.forEach((content) => {
						content.classList.toggle(
							"hidden",
							(content as HTMLElement).dataset.tabContent !==
								target,
						);
					});
					applyCategoryFilter();
				});
			});

			const inputs = document.querySelectorAll("#input-form input");
			const updateCommands = () => {
				const values: Record<string, string> = {};
				inputs.forEach((input) => {
					const htmlInput = input as HTMLInputElement;
					const label = htmlInput.previousElementSibling?.textContent
						?.trim()
						.toUpperCase();
					if (label) values[label] = htmlInput.value;
				});

				document
					.querySelectorAll("[data-tab-content] span")
					.forEach((span) => {
						const el = span as HTMLSpanElement;

						let raw = el.dataset.raw || el.textContent || "";
						el.dataset.raw = raw;
						Object.entries(values).forEach(([key, value]) => {
							raw = raw.replaceAll(`{{${key}}}`, value);
						});
						el.textContent = raw;
					});
			};

			inputs.forEach((input) =>
				input.addEventListener("input", updateCommands),
			);

			document.querySelectorAll("button").forEach((button) => {
				if (button.textContent?.trim() === "COPY") {
					button.addEventListener("click", () => {
						const span =
							button.parentElement?.querySelector("span");
						if (!span) return;
						const command = span.textContent;
						if (!command) return;
						navigator.clipboard.writeText(command).then(() => {
							button.textContent = "COPIED!";
							button.classList.remove("bg-white");
							button.classList.add("bg-green-600");
							setTimeout(() => {
								button.textContent = "COPY";
								button.classList.add("bg-white");
								button.classList.remove("bg-green-600");
							}, 1000);
						});
					});
				}
			});

			const applyCategoryFilter = () => {
				const checked = Array.from(
					document.querySelectorAll(".category-filter:checked"),
				).map((i) => (i as HTMLInputElement).value);

				document
					.querySelectorAll("[data-tab-content]")
					.forEach((tabContent) => {
						tabContent
							.querySelectorAll("[data-category]")
							.forEach((el) => {
								const category = (el as HTMLElement).dataset
									.category;
								el.classList.toggle(
									"hidden",
									!checked.includes(category || ""),
								);
							});
					});
			};

			document.querySelectorAll(".category-filter").forEach((cb) => {
				cb.addEventListener("change", applyCategoryFilter);
			});
		</script>
	</main>
</Layout>
